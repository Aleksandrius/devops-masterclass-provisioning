
task zipAnsible(type: Zip) {
  from 'ansible'
  archiveName = 'ansible.zip'
  destinationDir = projectDir
}

task provisionAnsible(dependsOn: zipAnsible) { doLast {
  remoteSession {
    if (project.hasProperty('ansibleClean')) {
      exec 'sudo rm -rf /tmp/deploy-ansible'
    }
    exec 'mkdir -p /tmp/deploy-ansible'
    sshOptions.verbose = false
    scp {
      from { localDir "ansible.zip" }
      into { remoteDir "/tmp/deploy-ansible" }
    }
    sshOptions.verbose = true
    exec 'sudo unzip -q -o /tmp/deploy-ansible/ansible.zip -d /tmp/deploy-ansible'
    exec 'cd /tmp/deploy-ansible ; sudo ansible-playbook site.yml'
  }
}}
