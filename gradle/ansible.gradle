
task zipAnsible(type: Zip, group: 'Infrastructure preparation') {
  from 'ansible'
  archiveName = 'ansible.zip'
  destinationDir = buildDir
}

task provisionAnsible(dependsOn: zipAnsible, group: 'Infrastructure preparation') { doLast {
  remoteSession {
    if (project.hasProperty('ansibleClean')) {
      exec 'sudo rm -rf /tmp/deploy-ansible'
    }
    exec 'mkdir -p /tmp/deploy-ansible'
    sshOptions.verbose = false
    scp {
      from { localFile "${buildDir}/ansible.zip" }
      into { remoteDir "/tmp/deploy-ansible" }
    }
    sshOptions.verbose = true
    exec 'sudo unzip -q -o /tmp/deploy-ansible/ansible.zip -d /tmp/deploy-ansible'
    exec 'cd /tmp/deploy-ansible ; sudo ansible-galaxy install -r requirements.yml'
    exec 'cd /tmp/deploy-ansible ; sudo ansible-playbook site.yml'
  }
}}
