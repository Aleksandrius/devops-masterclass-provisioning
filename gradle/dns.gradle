
task generateSSLCertificates(group: 'Infrastructure preparation') { doLast {
  remoteSession {
    exec "mkdir -p /home/ubuntu/.secrets/certbot"
    exec "touch /home/ubuntu/.secrets/certbot/cloudflare.ini"
    remoteFile('/home/ubuntu/.secrets/certbot/cloudflare.ini').text = "dns_cloudflare_email = andrey@aestasit.com\ndns_cloudflare_api_key = ${file('secrets/cloudflare.token').text}"
    exec "chmod 600 /home/ubuntu/.secrets/certbot/cloudflare.ini"
    exec "sudo docker run --rm --name certbot -it -p 80:80 -p 443:443 " +
           "-v /etc/letsencrypt:/etc/letsencrypt/ " +
           "-v /var/log/letsencrypt:/var/log/letsencrypt " +
           "-v /home/ubuntu/.secrets/certbot:/secrets " +
           "certbot/dns-cloudflare certonly --dns-cloudflare " +
           "--dns-cloudflare-credentials /secrets/cloudflare.ini --dns-cloudflare-propagation-seconds 60 " +
           "-n --agree-tos -m andrey@aestasit.com -d *.extremeautomation.io --server https://acme-v02.api.letsencrypt.org/directory"
  }
}}

task copySSLCertificates(group: 'Infrastructure preparation') { doLast {
  remoteSession {
    exec "sudo zip -r /tmp/letsencrypt.zip /etc/letsencrypt"
    scp {
      from { remoteFile "/tmp/letsencrypt.zip" }
      into { localDir "secrets"}
    }
  }
}}

