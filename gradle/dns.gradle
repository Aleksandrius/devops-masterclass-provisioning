
task generateSSLCertificates(group: 'Infrastructure preparation') { doLast {
  remoteSession {
    def hostNames = [
        "course",
        "gitlab",
        "jenkins",
        "kibana",
        "rancher",
        "kube",
        "swarm",
        "registry",
        "grafana",
        "vault",
        "prometheus",
        "logs",
    ]
    String certBotParams = hostNames.collect { "-d ${it}.extremeautomation.io"}.join(" ")
    exec "sudo docker run --rm -it -p 80:80 -v /etc/letsencrypt:/etc/letsencrypt/ -v /var/log/letsencrypt:/var/log/letsencrypt certbot/certbot certonly --standalone --preferred-challenges http -n --agree-tos --expand -m andrey@aestasit.com ${certBotParams}"
  }
}}

task copySSLCertificates(group: 'Infrastructure preparation') { doLast {
  remoteSession {
    exec "sudo zip -r /tmp/letsencrypt.zip /etc/letsencrypt"
    scp {
      from { remoteFile "/tmp/letsencrypt.zip" }
      into { localDir "secrets"}
    }
  }
}}

